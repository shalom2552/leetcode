name: Update Readme Table
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Generate Smart Suffix Readme
      run: |
        python3 -c "
        import os
        import json
        import urllib.parse
        import re

        GITHUB_USER = 'shalom2552'
        
        header = f'''# LeetCode Portfolio

        A collection of my accepted LeetCode solutions. Focused on efficient algorithms, data structures, and clean code standards.

        ## Live Stats
        <p align=\"center\">
          <img src=\"https://leetcard.jacoblin.cool/{GITHUB_USER}?theme=tokyonight&font=baloo_2&ext=heatmap\" width=\"800\" alt=\"LeetCode Stats\" />
        </p>

        ## Solutions
        | # | Problem | Solutions | Difficulty |
        |:---:|:---|:---:|:---:|
        '''

        stats_data = {}
        if os.path.exists('stats.json'):
            try:
                with open('stats.json', 'r') as f:
                    stats_data = json.load(f)
            except:
                pass

        problems_list = []
        valid_extensions = ('.py', '.cpp', '.c', '.cc', '.java', '.js', '.ts', '.cs', '.go', '.rs', '.rb', '.swift', '.kt')

        for root, dirs, files in os.walk('.'):
            if '.git' in root or '.github' in root:
                continue

            folder_name = os.path.basename(root)
            code_files = [f for f in files if f.lower().endswith(valid_extensions)]
            
            if code_files:
                code_files.sort()
                
                solution_links = []
                clean_folder_name = re.sub(r'^\d+-?', '', folder_name).lower()

                for code_file in code_files:
                    full_path = os.path.join(root, code_file)
                    relative_path = os.path.relpath(full_path, '.')
                    url_path = urllib.parse.quote(relative_path)
                    
                    ext = os.path.splitext(code_file)[1].replace('.', '')
                    file_name_no_ext = os.path.splitext(code_file)[0]
                    clean_file_name = re.sub(r'^\d+-?', '', file_name_no_ext).lower()
                    
                    label = ext
                    if clean_file_name != clean_folder_name:
                        suffix = clean_file_name.replace(clean_folder_name, '').upper()
                        if suffix:
                             label = f'{ext}{suffix}'

                    solution_links.append(f'[{label}]({url_path})')
                
                solutions_cell = ' '.join(solution_links)

                difficulty = 'Unknown'
                problem_num = 9999
                clean_display_name = folder_name.replace('-', ' ').title()

                if folder_name in stats_data:
                    difficulty = stats_data[folder_name].get('difficulty', 'Unknown')
                
                match = re.search(r'(\d+)', folder_name)
                if match:
                    problem_num = int(match.group(1))
                    clean_display_name = re.sub(r'^\d+-?', '', folder_name).replace('-', ' ').title()
                
                if difficulty == 'Unknown' and 'readme.md' in [f.lower() for f in files]:
                    try:
                        readme_name = next(f for f in files if f.lower() == 'readme.md')
                        with open(os.path.join(root, readme_name), 'r', encoding='utf-8') as f:
                            content = f.read()
                            if 'Easy' in content: difficulty = 'Easy'
                            elif 'Medium' in content: difficulty = 'Medium'
                            elif 'Hard' in content: difficulty = 'Hard'
                    except:
                        pass

                folder_url = urllib.parse.quote(os.path.relpath(root, '.'))
                slug = clean_display_name.lower().strip().replace(' ', '-')
                leetcode_link = f'https://leetcode.com/problems/{slug}'

                colors = {'Easy': 'green', 'Medium': 'orange', 'Hard': 'red', 'Unknown': 'grey'}
                badge_color = colors.get(difficulty, 'grey')
                badge = f'<img src=\"https://img.shields.io/badge/-{difficulty}-{badge_color}\" alt=\"{difficulty}\">'
                
                problems_list.append({
                    'num': problem_num,
                    'line': f'| [{problem_num}]({leetcode_link}) | [{clean_display_name}]({folder_url}) | {solutions_cell} | {badge} |'
                })

        problems_list.sort(key=lambda x: x['num'])
        
        final_content = header
        for p in problems_list:
            final_content += p['line'] + '\\n'

        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(final_content)
        "

    - name: Commit and Push
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git add README.md
        git commit -m "docs: auto-update README with latest solutions" || exit 0
        git pull --rebase origin main
        git push
