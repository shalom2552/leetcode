name: Update Readme Table
on:
  push:
    branches: [ main, master ]
    paths-ignore:
      - 'README.md'

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Generate Multi-Language Readme
      run: |
        python3 -c "
        import os
        import json
        import urllib.parse
        import re

        GITHUB_USER = 'shalom2552'
        
        # --- 1. Header ---
        header = f'''# LeetCode Portfolio

        A collection of my accepted LeetCode solutions. Focused on efficient algorithms, data structures, and clean code standards.

        <p align=\"center\">
          <img src=\"https://leetcard.jacoblin.cool/{GITHUB_USER}?theme=tokyonight&font=baloo_2&ext=heatmap\" width=\"100%\" alt=\"LeetCode Stats\" />
        </p>

        ## ðŸ“š Solutions
        | # | Problem | Solutions | Difficulty |
        |---|---|---|---|
        '''

        # --- 2. Load Stats ---
        stats_data = {}
        if os.path.exists('stats.json'):
            try:
                with open('stats.json', 'r') as f:
                    stats_data = json.load(f)
            except:
                pass

        problems_list = []
        valid_extensions = ('.py', '.cpp', '.c', '.cc', '.java', '.js', '.ts', '.cs', '.go', '.rs', '.rb', '.swift', '.kt')

        # --- 3. Scan Folders ---
        for root, dirs, files in os.walk('.'):
            if '.git' in root or '.github' in root:
                continue

            folder_name = os.path.basename(root)
            
            # Find ALL valid code files in this folder
            code_files = [f for f in files if f.lower().endswith(valid_extensions)]
            
            if code_files:
                # Sort files to keep order consistent (e.g. c, cpp, py)
                code_files.sort()
                
                # --- A. Generate Solution Links (The Fix) ---
                solution_links = []
                for code_file in code_files:
                    full_path = os.path.join(root, code_file)
                    relative_path = os.path.relpath(full_path, '.')
                    url_path = urllib.parse.quote(relative_path)
                    
                    # Get extension (e.g. 'py', 'cpp')
                    ext = os.path.splitext(code_file)[1].replace('.', '')
                    
                    # Create link: [cpp](url)
                    solution_links.append(f'[{ext}]({url_path})')
                
                # Join all links with a separator
                solutions_cell = ' '.join(solution_links)

                # --- B. Meta Data ---
                difficulty = 'Unknown'
                problem_num = 9999
                clean_name = folder_name.replace('-', ' ').title()

                # Try stats.json
                if folder_name in stats_data:
                    difficulty = stats_data[folder_name].get('difficulty', 'Unknown')
                
                # Fallback: Parse Number
                match = re.search(r'(\d+)', folder_name)
                if match:
                    problem_num = int(match.group(1))
                    clean_name = re.sub(r'^\d+-?', '', folder_name).replace('-', ' ').title()
                
                # Fallback: Check local README
                if difficulty == 'Unknown' and 'readme.md' in [f.lower() for f in files]:
                    try:
                        readme_name = next(f for f in files if f.lower() == 'readme.md')
                        with open(os.path.join(root, readme_name), 'r', encoding='utf-8') as f:
                            content = f.read()
                            if 'Easy' in content: difficulty = 'Easy'
                            elif 'Medium' in content: difficulty = 'Medium'
                            elif 'Hard' in content: difficulty = 'Hard'
                    except:
                        pass

                # Links & Badges
                slug = clean_name.lower().strip().replace(' ', '-')
                leetcode_link = f'https://leetcode.com/problems/{slug}'

                colors = {'Easy': 'green', 'Medium': 'orange', 'Hard': 'red', 'Unknown': 'grey'}
                badge_color = colors.get(difficulty, 'grey')
                badge = f'![](https://img.shields.io/badge/-{difficulty}-{badge_color})'
                
                problems_list.append({
                    'num': problem_num,
                    'line': f'| {problem_num} | [{clean_name}]({leetcode_link}) | {solutions_cell} | {badge} |'
                })

        # --- 4. Write ---
        problems_list.sort(key=lambda x: x['num'])
        
        final_content = header
        for p in problems_list:
            final_content += p['line'] + '\\n'

        with open('README.md', 'w', encoding='utf-8') as f:
            f.write(final_content)
        "

    - name: Commit and Push
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        git add README.md
        git commit -m "Update README with multi-language support" || exit 0
        git pull --rebase origin main
        git push
